<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Перемещения учителей по Москве</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet: фоновая карта -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    svg { position: absolute; top: 0; left: 0; }
    .arc { fill: none; stroke: steelblue; stroke-width: 2; opacity: 0.8; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // Инициализация карты Москвы
  const map = L.map('map').setView([55.7558, 37.6173], 12);

  // Добавим слой карты OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // SVG-слой поверх карты
  const svg = d3.select(map.getPanes().overlayPane).append("svg");
  const g = svg.append("g").attr("class", "leaflet-zoom-hide");

  // Пример перемещений
  const movements = [
    { from: [55.7558, 37.6173], to: [55.7600, 37.6250] },
    { from: [55.7512, 37.6184], to: [55.7400, 37.6250] },
    { from: [55.7700, 37.6100], to: [55.7558, 37.6173] },
  ];

  function projectPoint(lat, lng) {
    return map.latLngToLayerPoint(new L.LatLng(lat, lng));
  }

  function drawArcs() {
    const bounds = map.getBounds();
    const topLeft = map.latLngToLayerPoint(bounds.getNorthWest());
    const bottomRight = map.latLngToLayerPoint(bounds.getSouthEast());

    svg.attr("width", bottomRight.x - topLeft.x)
       .attr("height", bottomRight.y - topLeft.y)
       .style("left", topLeft.x + "px")
       .style("top", topLeft.y + "px");

    g.attr("transform", `translate(${-topLeft.x},${-topLeft.y})`);

    const arcs = g.selectAll("path")
      .data(movements)
      .join("path")
      .attr("class", "arc")
      .attr("d", d => {
        const p1 = projectPoint(...d.from);
        const p2 = projectPoint(...d.to);
        const mx = (p1.x + p2.x) / 2;
        const my = (p1.y + p2.y) / 2 - 30; // поднимаем для кривизны
        return `M${p1.x},${p1.y} Q${mx},${my} ${p2.x},${p2.y}`;
      });
  }

  map.on("moveend", drawArcs);
  drawArcs();
</script>

</body>
</html>
